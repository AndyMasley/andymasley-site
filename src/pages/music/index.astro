---
import Base from '@/layouts/Base.astro';
import { getCollection } from 'astro:content';

const allMusic = await getCollection('music', ({ data }) => !data.draft);
const items = allMusic.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Get all unique genres
const allGenres = [...new Set(items.flatMap(item => item.data.genre))].sort();

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', { 
    year: 'numeric',
    month: 'short'
  });
}

function formatRating(rating?: number): string {
  if (!rating) return '';
  return rating.toFixed(1);
}
---

<Base title="Music" description="Album reviews, recommendations, and music notes">
  <div class="container container--wide">
    <header class="page-header">
      <h1 class="page-header__title">Music</h1>
      <p class="page-header__subtitle">
        Album reviews, artist notes, and sonic explorationsâ€”from noise rock to whatever catches my ear.
      </p>
      <p class="section-header__count">{items.length} entries</p>
    </header>

    {allGenres.length > 0 && (
      <div class="filter-bar">
        <span class="filter-label">Filter:</span>
        <div class="tags">
          <button class="tag tag--filter tag--active" data-genre="all">All</button>
          {allGenres.map(genre => (
            <button class="tag tag--filter" data-genre={genre}>{genre}</button>
          ))}
        </div>
      </div>
    )}

    <ul class="music-grid stagger-in" id="music-list">
      {items.map(item => (
        <li class="music-item" data-genres={item.data.genre.join(',')}>
          <a href={`/music/${item.slug}`} class="music-item__link">
            <div class="music-item__content">
              <h3 class="music-item__title">{item.data.album || item.data.title}</h3>
              {item.data.artist && (
                <p class="music-item__artist">{item.data.artist}</p>
              )}
              <div class="music-item__meta">
                {item.data.year && <span>{item.data.year}</span>}
                {item.data.rating && (
                  <span class="music-item__rating">{formatRating(item.data.rating)}</span>
                )}
              </div>
            </div>
            {item.data.genre.length > 0 && (
              <div class="music-item__genres">
                {item.data.genre.slice(0, 2).map(g => (
                  <span class="genre-tag">{g}</span>
                ))}
              </div>
            )}
          </a>
        </li>
      ))}
    </ul>
  </div>
</Base>

<script>
  const filterButtons = document.querySelectorAll('.tag--filter');
  const items = document.querySelectorAll('.music-item');
  
  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      const genre = button.getAttribute('data-genre');
      
      // Update active state
      filterButtons.forEach(b => b.classList.remove('tag--active'));
      button.classList.add('tag--active');
      
      // Filter items
      items.forEach(item => {
        const itemGenres = item.getAttribute('data-genres')?.split(',') || [];
        if (genre === 'all' || itemGenres.includes(genre)) {
          item.style.display = '';
          item.classList.add('expand-in');
        } else {
          item.style.display = 'none';
          item.classList.remove('expand-in');
        }
      });
    });
  });
</script>

<style>
  .filter-bar {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-2xl);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--border-subtle);
    overflow-x: auto;
  }
  
  .filter-label {
    font-size: 0.8125rem;
    color: var(--text-tertiary);
    white-space: nowrap;
  }
  
  .tag--filter {
    cursor: pointer;
    border: none;
    font-family: inherit;
  }
  
  .tag--active {
    background: var(--accent);
    color: white;
  }

  .music-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-lg);
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .music-item__link {
    display: flex;
    flex-direction: column;
    height: 100%;
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: 8px;
    text-decoration: none;
    color: inherit;
    transition: border-color var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
  }
  
  .music-item__link:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }
  
  .music-item__content {
    flex: 1;
  }
  
  .music-item__title {
    font-family: var(--font-serif);
    font-size: 1.0625rem;
    font-weight: 500;
    margin: 0 0 var(--space-xs) 0;
    color: var(--text-primary);
  }
  
  .music-item__artist {
    font-size: 0.9375rem;
    color: var(--text-secondary);
    margin: 0 0 var(--space-sm) 0;
  }
  
  .music-item__meta {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    font-size: 0.8125rem;
    color: var(--text-tertiary);
  }
  
  .music-item__rating {
    font-weight: 600;
    color: var(--accent);
  }
  
  .music-item__genres {
    display: flex;
    gap: var(--space-xs);
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-subtle);
  }
  
  .genre-tag {
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-tertiary);
  }
</style>
