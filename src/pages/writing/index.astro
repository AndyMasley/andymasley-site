---
import Base from '@/layouts/Base.astro';
import { fetchSubstackPosts, groupByCategory, getCategoryConfig } from '@/lib/substack';

const posts = await fetchSubstackPosts();
const postsByCategory = groupByCategory(posts);
const categories = Object.keys(postsByCategory);

// Format date as MM.DD.YYYY
function formatDate(date: Date): string {
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const year = date.getFullYear();
  return `${month}.${day}.${year}`;
}
---

<Base title="Writing">
  <div class="page-header">
    <h2 class="page-header__title">Writing</h2>
    <p class="page-header__description">
      Essays and analysis from <a href="https://andymasley.substack.com" target="_blank" rel="noopener">Substack</a>.
    </p>
  </div>

  <div class="jump-links">
    <span class="jump-links__label">Jump: </span>
    {categories.map((cat, i) => (
      <>
        {i > 0 && <span class="jump-links__sep"> · </span>}
        <a href={`#cat-${getCategoryConfig(cat)?.slug || cat.toLowerCase().replace(/\s+/g, '-')}`}>{cat}</a>
      </>
    ))}
  </div>

  <div class="controls">
    <a href="#" id="expand-all">[expand all]</a>
    <span class="jump-links__sep"> · </span>
    <a href="#" id="collapse-all">[collapse all]</a>
  </div>

  <hr class="divider" />

  <div class="label">Blog</div>

  {Object.entries(postsByCategory).map(([category, categoryPosts]) => {
    const config = getCategoryConfig(category);
    const slug = config?.slug || category.toLowerCase().replace(/\s+/g, '-');
    return (
      <div class="section" id={`cat-${slug}`}>
        <div class="section__header" data-section={category}>
          <span class="section__toggle">▼</span>
          <span class="section__title">{category}</span>
          <span class="section__count">({categoryPosts.length})</span>
        </div>
        <div class="section__content" data-content={category}>
          {config?.overview && (
            <p class="category-overview">{config.overview}</p>
          )}
          <div class="recent-label">Recent</div>
          {categoryPosts.map(post => (
            <div class="content-item">
              <span class="content-item__date">{formatDate(post.date)}</span>
              <a href={post.url} target="_blank" rel="noopener" class="content-item__link">
                {post.title}
              </a>
            </div>
          ))}
        </div>
      </div>
    );
  })}

  <hr class="divider" />

  <div class="back-link">
    <a href="/">← index</a>
  </div>

  <p class="meta">
    Last updated: {formatDate(new Date())} · {posts.length} posts
  </p>
</Base>

<style>
  .category-overview {
    font-size: 0.875rem;
    color: var(--dim);
    margin: 0 0 12px 0;
    line-height: 1.5;
  }

  .recent-label {
    font-size: 0.75rem;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
    padding-top: 4px;
    border-top: 1px solid var(--border);
  }

  .meta {
    font-size: 0.75rem;
    color: var(--dim);
    margin-top: 24px;
  }
</style>

<script>
  document.querySelectorAll('.section__header').forEach(header => {
    header.addEventListener('click', () => {
      const section = header.getAttribute('data-section');
      const content = document.querySelector(`[data-content="${section}"]`) as HTMLElement;
      const toggle = header.querySelector('.section__toggle');

      if (content && toggle) {
        const isCollapsed = content.style.display === 'none';
        content.style.display = isCollapsed ? 'block' : 'none';
        toggle.textContent = isCollapsed ? '▼' : '▶';
      }
    });
  });

  document.getElementById('expand-all')?.addEventListener('click', (e) => {
    e.preventDefault();
    document.querySelectorAll('.section__content').forEach(content => {
      (content as HTMLElement).style.display = 'block';
    });
    document.querySelectorAll('.section__toggle').forEach(toggle => {
      toggle.textContent = '▼';
    });
  });

  document.getElementById('collapse-all')?.addEventListener('click', (e) => {
    e.preventDefault();
    document.querySelectorAll('.section__content').forEach(content => {
      (content as HTMLElement).style.display = 'none';
    });
    document.querySelectorAll('.section__toggle').forEach(toggle => {
      toggle.textContent = '▶';
    });
  });
</script>
