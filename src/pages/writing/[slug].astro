---
import Base from '@/layouts/Base.astro';
import { getCollection } from 'astro:content';
import { fetchSubstackPosts, fetchPostContent, processPostContent, type SubstackPost } from '@/lib/substack';
import { fetchEAForumPosts, fetchEAForumPostContent, processEAForumContent, type EAForumPost } from '@/lib/eaforum';
import { getMetaPostSlugs } from '@/lib/meta-posts';

// Union type for all post sources
type PostSource = 'local' | 'substack' | 'eaforum';

interface LocalPost {
  source: 'local';
  slug: string;
  title: string;
  date: Date;
  description: string;
  tags: string[];
  body: string;
  render: () => Promise<{ Content: any; headings: any[] }>;
}

interface ExternalPost {
  source: 'substack' | 'eaforum';
  slug: string;
  title: string;
  date: Date;
  description: string;
  url: string;
  htmlContent: string;
  sourceName: string;
}

type Post = LocalPost | ExternalPost;

export async function getStaticPaths() {
  const paths: Array<{ params: { slug: string }; props: { post: Post } }> = [];

  // 1. Get local content collection posts
  const localPosts = await getCollection('writing');
  for (const post of localPosts) {
    paths.push({
      params: { slug: post.slug },
      props: {
        post: {
          source: 'local' as const,
          slug: post.slug,
          title: post.data.title,
          date: post.data.date,
          description: post.data.description || '',
          tags: post.data.tags || [],
          body: post.body,
          render: () => post.render(),
        }
      }
    });
  }

  // 2. Get Substack posts
  const metaSlugs = getMetaPostSlugs();
  const substackPosts = await fetchSubstackPosts();

  for (const post of substackPosts) {
    // Skip meta posts and posts that conflict with local content
    if (metaSlugs.includes(post.slug)) continue;
    if (paths.some(p => p.params.slug === post.slug)) continue;

    // Fetch full content
    const rawContent = await fetchPostContent(post.slug);
    const htmlContent = processPostContent(rawContent, post.slug);

    paths.push({
      params: { slug: post.slug },
      props: {
        post: {
          source: 'substack' as const,
          slug: post.slug,
          title: post.title,
          date: post.date,
          description: post.description,
          url: post.url,
          htmlContent,
          sourceName: 'Substack',
        }
      }
    });
  }

  // 3. Get EA Forum posts
  const eaForumPosts = await fetchEAForumPosts();

  for (const post of eaForumPosts) {
    // Skip posts that conflict with existing paths
    if (paths.some(p => p.params.slug === post.slug)) continue;

    // Fetch full content
    const rawContent = await fetchEAForumPostContent(post.postId);
    const htmlContent = processEAForumContent(rawContent, post.slug);

    paths.push({
      params: { slug: post.slug },
      props: {
        post: {
          source: 'eaforum' as const,
          slug: post.slug,
          title: post.title,
          date: post.date,
          description: '',
          url: post.url,
          htmlContent,
          sourceName: 'EA Forum',
        }
      }
    });
  }

  return paths;
}

interface Props {
  post: Post;
}

const { post } = Astro.props;

// Format date as MM.DD.YYYY
function formatDate(date: Date): string {
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const year = date.getFullYear();
  return `${month}.${day}.${year}`;
}

// Estimate reading time
function getReadingTime(content: string): number {
  const text = content.replace(/<[^>]*>/g, ''); // Strip HTML
  const wordCount = text.split(/\s+/).length;
  return Math.ceil(wordCount / 200);
}

// Get content and metadata based on source
let Content: any = null;
let readingTime = 0;

if (post.source === 'local') {
  const rendered = await post.render();
  Content = rendered.Content;
  readingTime = Math.ceil(post.body.split(/\s+/).length / 200);
} else {
  readingTime = getReadingTime(post.htmlContent);
}
---

<Base
  title={post.title}
  description={post.description}
>
  <article class="container container--narrow">
    {post.source !== 'local' && (
      <p class="originally-on">
        Originally on <a href={post.url} target="_blank" rel="noopener">{post.sourceName}</a>
      </p>
    )}

    <header class="article-header">
      <h1 class="article-header__title">{post.title}</h1>
      <div class="article-header__meta">
        <span class="article-header__date">{formatDate(post.date)}</span>
        <span class="article-header__reading-time">{readingTime} min read</span>
      </div>
    </header>

    <div class="prose">
      {post.source === 'local' ? (
        <Content />
      ) : (
        <Fragment set:html={post.htmlContent} />
      )}
    </div>

    <footer class="article-footer">
      <nav class="article-nav">
        <a href="/writing" class="article-nav__link">
          ‚Üê Back to all writing
        </a>
      </nav>
    </footer>
  </article>
</Base>

<style>
  .originally-on {
    font-size: var(--font-size-ui);
    color: var(--dim);
    margin-bottom: var(--space-lg);
  }

  .originally-on a {
    color: var(--accent);
    text-decoration: underline;
    text-underline-offset: var(--underline-offset);
  }

  .article-header {
    margin-bottom: var(--space-xl);
  }

  .article-header__title {
    font-size: var(--font-size-h1);
    font-weight: var(--font-weight-heading);
    line-height: var(--line-height-h1);
    margin-bottom: var(--space-sm);
  }

  .article-header__meta {
    display: flex;
    gap: var(--space-md);
    font-size: var(--font-size-mono);
    font-family: var(--font-mono);
    color: var(--dim);
  }

  .article-footer {
    margin-top: var(--space-2xl);
    padding-top: var(--space-xl);
    border-top: 1px solid var(--border);
  }

  .article-nav__link {
    font-size: var(--font-size-ui);
    color: var(--accent);
    text-decoration: underline;
    text-underline-offset: var(--underline-offset);
  }

  /* Prose styles for external content */
  .prose :global(img) {
    max-width: 100%;
    height: auto;
    margin: var(--space-lg) 0;
  }

  .prose :global(figure) {
    margin: var(--space-lg) 0;
  }

  .prose :global(figcaption) {
    font-size: var(--font-size-ui);
    color: var(--dim);
    text-align: center;
    margin-top: var(--space-sm);
  }

  .prose :global(blockquote) {
    border-left: 3px solid var(--accent);
    padding-left: var(--space-md);
    margin: var(--space-lg) 0;
    color: var(--dim);
    font-style: italic;
  }

  .prose :global(pre) {
    background: var(--border);
    padding: var(--space-md);
    border-radius: 4px;
    overflow-x: auto;
    font-family: var(--font-mono);
    font-size: var(--font-size-mono);
  }

  .prose :global(code) {
    font-family: var(--font-mono);
    font-size: var(--font-size-mono);
    background: var(--border);
    padding: 0.1em 0.3em;
    border-radius: 2px;
  }

  .prose :global(pre code) {
    background: none;
    padding: 0;
  }

  .prose :global(a) {
    color: var(--accent);
    text-decoration: underline;
    text-underline-offset: var(--underline-offset);
  }

  .prose :global(h2) {
    font-size: var(--font-size-h2);
    font-weight: var(--font-weight-heading);
    line-height: var(--line-height-h2);
    margin-top: var(--space-xl);
    margin-bottom: var(--space-md);
  }

  .prose :global(h3) {
    font-size: var(--font-size-h3);
    font-weight: var(--font-weight-heading);
    line-height: var(--line-height-h3);
    margin-top: var(--space-lg);
    margin-bottom: var(--space-sm);
  }

  .prose :global(p) {
    margin-bottom: var(--space-md);
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: var(--space-md);
    padding-left: var(--space-lg);
  }

  .prose :global(li) {
    margin-bottom: var(--space-sm);
  }

  /* Substack-specific styles */
  .prose :global(.image-link),
  .prose :global(.image2) {
    display: block;
    margin: var(--space-lg) 0;
  }

  .prose :global(.image-link img),
  .prose :global(.image2 img) {
    max-width: 100%;
    height: auto;
  }

  .prose :global(.captioned-image-container) {
    margin: var(--space-lg) 0;
  }

  .prose :global(.image-caption) {
    font-size: var(--font-size-ui);
    color: var(--dim);
    text-align: center;
    margin-top: var(--space-sm);
  }

  /* Hide Substack subscription widgets */
  .prose :global(.subscription-widget-wrap),
  .prose :global(.subscribe-widget),
  .prose :global(.subscription-widget) {
    display: none !important;
  }
</style>
