---
import Base from '@/layouts/Base.astro';
import TableOfContents from '@/components/TableOfContents.astro';
import ArticlePagination from '@/components/ArticlePagination.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('writing');
  const sortedPosts = posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
  
  return sortedPosts.map((post, index) => ({
    params: { slug: post.slug },
    props: { 
      post,
      prevPost: sortedPosts[index + 1] ? { slug: sortedPosts[index + 1].slug, title: sortedPosts[index + 1].data.title } : undefined,
      nextPost: sortedPosts[index - 1] ? { slug: sortedPosts[index - 1].slug, title: sortedPosts[index - 1].data.title } : undefined,
    },
  }));
}

interface Props {
  post: CollectionEntry<'writing'>;
  prevPost?: { slug: string; title: string };
  nextPost?: { slug: string; title: string };
}

const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await post.render();

// Check if article is long enough to warrant a TOC
const hasEnoughHeadings = headings.filter(h => h.depth === 2 || h.depth === 3).length >= 3;

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', { 
    year: 'numeric',
    month: 'long', 
    day: 'numeric' 
  });
}

// Estimate reading time (rough: 200 words per minute)
const wordCount = post.body.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);
---

<Base 
  title={post.data.title} 
  description={post.data.description}
  showReadingProgress={true}
>
  <div class="article-layout">
    {hasEnoughHeadings && (
      <aside class="article-sidebar">
        <TableOfContents headings={headings} />
      </aside>
    )}
    
    <article class="container container--narrow">
      <nav class="breadcrumbs animate-in">
        <a href="/">Home</a>
        <span class="breadcrumbs__separator">/</span>
        <a href="/writing">Writing</a>
        <span class="breadcrumbs__separator">/</span>
        <span class="breadcrumbs__current">{post.data.title}</span>
      </nav>
      
      <header class="article-header animate-in">
        <h1 class="article-header__title">{post.data.title}</h1>
        <div class="article-header__meta">
          <span>
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect>
              <line x1="16" x2="16" y1="2" y2="6"></line>
              <line x1="8" x2="8" y1="2" y2="6"></line>
              <line x1="3" x2="21" y1="10" y2="10"></line>
            </svg>
            {formatDate(post.data.date)}
          </span>
          <span>
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            {readingTime} min read
          </span>
          {post.data.updated && (
            <span>Updated {formatDate(post.data.updated)}</span>
          )}
        </div>
        
        {post.data.tags.length > 0 && (
          <div class="tags mt-md">
            {post.data.tags.map(tag => (
              <a href={`/tags/${tag}`} class="tag">{tag}</a>
            ))}
          </div>
        )}
      </header>

      <div class="prose animate-in">
        <Content />
      </div>
      
      <footer class="article-footer">
        {post.data.external_url && (
          <p class="external-note">
            Originally published on <a href={post.data.external_url} target="_blank" rel="noopener">{post.data.publication || 'external site'}</a>.
          </p>
        )}
        
        <nav class="article-nav">
          <a href="/writing" class="article-nav__link">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m12 19-7-7 7-7"></path>
              <path d="M19 12H5"></path>
            </svg>
            Back to all writing
          </a>
        </nav>
        
        <ArticlePagination prevPost={prevPost} nextPost={nextPost} basePath="/writing" />
      </footer>
    </article>
  </div>
</Base>

<style>
  .article-layout {
    display: grid;
    grid-template-columns: 1fr min(var(--content-width), 100%) 1fr;
    gap: var(--space-xl);
  }
  
  .article-sidebar {
    display: none;
  }
  
  @media (min-width: 1200px) {
    .article-layout {
      grid-template-columns: 1fr min(var(--content-width), 100%) 220px;
    }
    
    .article-sidebar {
      display: block;
      padding-top: 200px; /* Align with content start */
    }
  }
  
  .article-footer {
    margin-top: var(--space-4xl);
    padding-top: var(--space-xl);
    border-top: 1px solid var(--border);
  }
  
  .external-note {
    font-size: var(--font-size-ui);
    color: var(--text-tertiary);
    font-style: italic;
    margin-bottom: var(--space-xl);
  }

  .article-nav {
    display: flex;
    justify-content: flex-start;
    margin-bottom: var(--space-xl);
  }

  .article-nav__link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--font-size-ui);
    color: var(--text-secondary);
    text-decoration: none;
    padding: var(--space-sm) var(--space-md);
    margin-left: calc(-1 * var(--space-md));
    border-radius: 6px;
    transition: background-color var(--transition-fast), color var(--transition-fast);
  }
  
  .article-nav__link:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }
</style>
