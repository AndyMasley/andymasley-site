---
import Base from '@/layouts/Base.astro';
import { getCollection } from 'astro:content';

const allPhysics = await getCollection('physics', ({ data }) => !data.draft);
const items = allPhysics.sort((a, b) => {
  const unitA = a.data.unit || 'zzz';
  const unitB = b.data.unit || 'zzz';
  if (unitA !== unitB) return unitA.localeCompare(unitB);
  return a.data.title.localeCompare(b.data.title);
});

// Group by unit
const itemsByUnit = items.reduce((acc, item) => {
  const unit = item.data.unit || 'Other';
  if (!acc[unit]) acc[unit] = [];
  acc[unit].push(item);
  return acc;
}, {} as Record<string, typeof items>);

const units = Object.keys(itemsByUnit).sort();
---

<Base title="IB Physics" description="Video lectures for the full IB Physics curriculum">
  <div class="page-header">
    <h2 class="page-header__title">IB Physics</h2>
    <p class="page-header__description">
      Complete video curriculum. All lectures on <a href="https://www.youtube.com/@andymasley" target="_blank" rel="noopener">YouTube</a>.
    </p>
  </div>

  <div class="jump-links">
    <span class="jump-links__label">Jump: </span>
    {units.map((unit, i) => (
      <>
        {i > 0 && <span class="jump-links__sep"> · </span>}
        <a href={`#unit-${unit.toLowerCase().replace(/\s+/g, '-')}`}>{unit}</a>
      </>
    ))}
  </div>

  <div class="controls">
    <a href="#" id="expand-all">[expand all]</a>
    <span class="jump-links__sep"> · </span>
    <a href="#" id="collapse-all">[collapse all]</a>
  </div>

  <hr class="divider" />

  {units.map(unit => (
    <div class="section" id={`unit-${unit.toLowerCase().replace(/\s+/g, '-')}`}>
      <div class="section__header" data-section={unit}>
        <span class="section__toggle">▼</span>
        <span class="section__title">{unit}</span>
        <span class="section__count">({itemsByUnit[unit].length})</span>
      </div>
      <div class="section__content" data-content={unit}>
        {itemsByUnit[unit].map(item => (
          <div class="content-item">
            <a href={`/physics/${item.slug}`} class="content-item__link">{item.data.title}</a>
            {item.data.youtube_url && (
              <a href={item.data.youtube_url} target="_blank" rel="noopener" class="video-link">[video]</a>
            )}
          </div>
        ))}
      </div>
    </div>
  ))}

  <hr class="divider" />

  <div class="back-link">
    <a href="/">← home</a>
  </div>
</Base>

<script>
  document.querySelectorAll('.section__header').forEach(header => {
    header.addEventListener('click', () => {
      const section = header.getAttribute('data-section');
      const content = document.querySelector(`[data-content="${section}"]`) as HTMLElement;
      const toggle = header.querySelector('.section__toggle');

      if (content && toggle) {
        const isCollapsed = content.style.display === 'none';
        content.style.display = isCollapsed ? 'block' : 'none';
        toggle.textContent = isCollapsed ? '▼' : '▶';
      }
    });
  });

  document.getElementById('expand-all')?.addEventListener('click', (e) => {
    e.preventDefault();
    document.querySelectorAll('.section__content').forEach(content => {
      (content as HTMLElement).style.display = 'block';
    });
    document.querySelectorAll('.section__toggle').forEach(toggle => {
      toggle.textContent = '▼';
    });
  });

  document.getElementById('collapse-all')?.addEventListener('click', (e) => {
    e.preventDefault();
    document.querySelectorAll('.section__content').forEach(content => {
      (content as HTMLElement).style.display = 'none';
    });
    document.querySelectorAll('.section__toggle').forEach(toggle => {
      toggle.textContent = '▶';
    });
  });
</script>

<style>
  .video-link {
    font-size: 0.8rem;
    margin-left: 8px;
    color: var(--dim);
  }
</style>
