---
import Base from '@/layouts/Base.astro';
import { getCollection } from 'astro:content';

// Get latest content from each collection
const allWriting = await getCollection('writing', ({ data }) => !data.draft);
const allMusic = await getCollection('music', ({ data }) => !data.draft);
const allBooks = await getCollection('books', ({ data }) => !data.draft);
const allNotes = await getCollection('notes', ({ data }) => !data.draft);

// Sort by date and take latest 5
const latestWriting = allWriting
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 5);

const latestMusic = allMusic
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 4);

const latestBooks = allBooks
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 4);

const latestNotes = allNotes
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 4);

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric' 
  });
}
---

<Base title="Home">
  <div class="container">
    <section class="home-intro stagger-in">
      <p class="home-intro__greeting">Hello</p>
      <h1 class="home-intro__title">
        I'm Andy Masleyâ€”writer, researcher, and director of Effective Altruism DC.
      </h1>
      <p class="home-intro__description">
        I spend my time thinking about AI policy, challenging conventional narratives with data, 
        and occasionally making noise music. This site is a collection of everything I find interesting.
      </p>
    </section>

    {latestWriting.length > 0 && (
      <section class="home-section">
        <div class="home-section__header">
          <h2 class="home-section__title">Recent Writing</h2>
          <a href="/writing" class="home-section__link">
            View all
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 12h14"></path>
              <path d="m12 5 7 7-7 7"></path>
            </svg>
          </a>
        </div>
        <ul class="content-list stagger-in">
          {latestWriting.map(post => (
            <li class="content-item">
              <a href={`/writing/${post.slug}`} class="content-item__link">
                <h3 class="content-item__title">{post.data.title}</h3>
                <div class="content-item__meta">
                  <span>{formatDate(post.data.date)}</span>
                  {post.data.publication && <span>{post.data.publication}</span>}
                </div>
                {post.data.description && (
                  <p class="content-item__description">{post.data.description}</p>
                )}
              </a>
            </li>
          ))}
        </ul>
      </section>
    )}

    {latestMusic.length > 0 && (
      <section class="home-section">
        <div class="home-section__header">
          <h2 class="home-section__title">Music</h2>
          <a href="/music" class="home-section__link">
            View all
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 12h14"></path>
              <path d="m12 5 7 7-7 7"></path>
            </svg>
          </a>
        </div>
        <div class="grid grid--2 stagger-in">
          {latestMusic.map(item => (
            <a href={`/music/${item.slug}`} class="card">
              <p class="card__title">{item.data.album || item.data.title}</p>
              {item.data.artist && (
                <p class="card__description">{item.data.artist}</p>
              )}
            </a>
          ))}
        </div>
      </section>
    )}

    {latestBooks.length > 0 && (
      <section class="home-section">
        <div class="home-section__header">
          <h2 class="home-section__title">Books</h2>
          <a href="/books" class="home-section__link">
            View all
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 12h14"></path>
              <path d="m12 5 7 7-7 7"></path>
            </svg>
          </a>
        </div>
        <div class="grid grid--2 stagger-in">
          {latestBooks.map(item => (
            <a href={`/books/${item.slug}`} class="card">
              <p class="card__title">{item.data.title}</p>
              {item.data.author && (
                <p class="card__description">{item.data.author}</p>
              )}
            </a>
          ))}
        </div>
      </section>
    )}

    {latestNotes.length > 0 && (
      <section class="home-section">
        <div class="home-section__header">
          <h2 class="home-section__title">Notes</h2>
          <a href="/notes" class="home-section__link">
            View all
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 12h14"></path>
              <path d="m12 5 7 7-7 7"></path>
            </svg>
          </a>
        </div>
        <ul class="content-list stagger-in">
          {latestNotes.map(note => (
            <li class="content-item">
              <a href={`/notes/${note.slug}`} class="content-item__link">
                <h3 class="content-item__title">{note.data.title}</h3>
                <div class="content-item__meta">
                  <span>{formatDate(note.data.date)}</span>
                  {note.data.category && <span class="tag">{note.data.category}</span>}
                </div>
              </a>
            </li>
          ))}
        </ul>
      </section>
    )}
  </div>
</Base>
