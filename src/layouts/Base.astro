---
import '@/styles/global.css';
import { ViewTransitions } from 'astro:transitions';

interface Props {
  title: string;
  description?: string;
  showReadingProgress?: boolean;
}

const {
  title,
  description = "Andy Masley's personal site",
  showReadingProgress = false,
} = Astro.props;
const currentPath = Astro.url.pathname;

const navLinks = [
  { href: '/', label: 'home' },
  { href: '/writing', label: 'writing' },
  { href: '/physics', label: 'ib physics' },
  { href: '/music', label: 'media recs' },
  { href: '/about', label: 'about' },
];

function isActive(href: string): boolean {
  if (href === '/') return currentPath === '/';
  return currentPath.startsWith(href);
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content={description}>
  <title>{title} — Andy Masley</title>

  <ViewTransitions />

  <link rel="alternate" type="application/rss+xml" title="Andy Masley" href="/rss.xml">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">

  <script is:inline>
    // Initialize theme immediately to prevent flash
    (function() {
      const stored = localStorage.getItem('theme');
      const theme = stored || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);

      // Persist theme across View Transitions
      document.addEventListener('astro:after-swap', () => {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
          document.documentElement.setAttribute('data-theme', savedTheme);
        }
      });

      // Handle tab visibility changes - restore from localStorage
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          const savedTheme = localStorage.getItem('theme');
          if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
          }
        }
      });
    })();
  </script>
</head>
<body>
  {showReadingProgress && <div class="reading-progress" id="reading-progress"></div>}

  <main class="main-content" transition:animate="fade">
    <header class="header">
      <div class="header__inner">
        <a href="/" class="header__logo">
          <svg class="hexagon" width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path
              d="M12 2L21.5 7.5V16.5L12 22L2.5 16.5V7.5L12 2Z"
              stroke="currentColor"
              stroke-width="1.5"
              fill="none"
              style="color: var(--accent);"
            />
          </svg>
          Andy Masley
        </a>

        <div class="header__controls">
          <button class="header__control" id="search-toggle">
            [search]
          </button>
          <button class="header__control" id="theme-toggle">
            [<span id="theme-label">dark</span>]
          </button>
        </div>
      </div>

      <nav class="header__nav">
        {navLinks.map((link, i) => (
          <>
            {i > 0 && <span class="header__nav-sep"> · </span>}
            <a
              href={link.href}
              class:list={[
                'header__nav-link',
                { 'header__nav-link--active': isActive(link.href) }
              ]}
            >
              {link.label}
            </a>
          </>
        ))}
      </nav>
    </header>

    <slot />

    <footer class="footer">
      <a href="/rss.xml">RSS</a> · <a href="mailto:AndyMasley@gmail.com">contact</a>
    </footer>
  </main>

  <!-- Search Modal -->
  <div id="search-modal" class="search-modal" style="display: none;">
    <div class="search-modal__backdrop"></div>
    <div class="search-modal__content">
      <input
        type="text"
        id="search-input"
        class="search-modal__input"
        placeholder="Search..."
        autocomplete="off"
      />
      <div id="search-results" class="search-modal__results"></div>
      <div class="search-modal__hint">esc to close</div>
    </div>
  </div>


  <script>
    document.addEventListener('astro:page-load', () => {
      initThemeToggle();
      initReadingProgress();
    });

    function initThemeToggle() {
      const themeToggle = document.getElementById('theme-toggle');
      const themeLabel = document.getElementById('theme-label');
      if (!themeToggle) return;

      function updateThemeLabel() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const label = document.getElementById('theme-label');
        if (label) {
          label.textContent = isDark ? 'light' : 'dark';
        }
      }

      updateThemeLabel();

      // Clone to remove any stale event listeners from View Transitions
      const newToggle = themeToggle.cloneNode(true) as HTMLElement;
      themeToggle.parentNode?.replaceChild(newToggle, themeToggle);

      newToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeLabel();
      });
    }

    function initReadingProgress() {
      const progressBar = document.getElementById('reading-progress');
      if (progressBar) {
        window.addEventListener('scroll', () => {
          const docHeight = document.documentElement.scrollHeight - window.innerHeight;
          const scrollPos = window.scrollY;
          const progress = (scrollPos / docHeight) * 100;
          progressBar.style.width = `${progress}%`;
        }, { passive: true });
      }
    }

    // Initialize on first load
    initThemeToggle();
    initReadingProgress();
  </script>

  <script is:inline>
    // Search functionality - inline to ensure immediate execution
    (function() {
      let searchIndex = null;
      let searchInitialized = false;

      async function loadSearchIndex() {
        if (searchIndex) return searchIndex;
        try {
          const response = await fetch('/search.json');
          searchIndex = await response.json();
          return searchIndex;
        } catch (e) {
          console.error('Failed to load search index:', e);
          return [];
        }
      }

      function initSearch() {
        if (searchInitialized) return;

        const searchToggle = document.getElementById('search-toggle');
        const searchModal = document.getElementById('search-modal');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const backdrop = searchModal ? searchModal.querySelector('.search-modal__backdrop') : null;

        if (!searchToggle || !searchModal || !searchInput || !searchResults) {
          return;
        }

        searchInitialized = true;

        function openSearch() {
          searchModal.style.display = 'flex';
          searchInput.value = '';
          searchResults.innerHTML = '';
          setTimeout(function() { searchInput.focus(); }, 10);
          loadSearchIndex();
        }

        function closeSearch() {
          searchModal.style.display = 'none';
        }

        searchToggle.addEventListener('click', openSearch);
        if (backdrop) {
          backdrop.addEventListener('click', closeSearch);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
          // cmd/ctrl + k to open
          if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            openSearch();
          }
          // esc to close
          if (e.key === 'Escape' && searchModal.style.display === 'flex') {
            closeSearch();
          }
        });

        // Search on input
        searchInput.addEventListener('input', async function() {
          const query = searchInput.value.toLowerCase().trim();
          if (!query) {
            searchResults.innerHTML = '';
            return;
          }

          const index = await loadSearchIndex();
          const results = index.filter(function(item) {
            const titleMatch = item.title.toLowerCase().includes(query);
            const descMatch = item.description && item.description.toLowerCase().includes(query);
            const tagMatch = item.tags && item.tags.some(function(t) { return t.toLowerCase().includes(query); });
            return titleMatch || descMatch || tagMatch;
          }).slice(0, 10);

          if (results.length === 0) {
            searchResults.innerHTML = '<div class="search-modal__empty">No results found</div>';
            return;
          }

          searchResults.innerHTML = results.map(function(item) {
            return '<a href="' + item.url + '" class="search-modal__result">' +
              '<span class="search-modal__result-title">' + item.title + '</span>' +
              '<span class="search-modal__result-type">' + item.type + '</span>' +
              '</a>';
          }).join('');
        });

        // Navigate with keyboard
        searchInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            const firstResult = searchResults.querySelector('a');
            if (firstResult) {
              window.location.href = firstResult.getAttribute('href');
            }
          }
        });
      }

      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSearch);
      } else {
        initSearch();
      }

      // Re-initialize after View Transitions
      document.addEventListener('astro:page-load', function() {
        searchInitialized = false;
        initSearch();
      });
    })();
  </script>
</body>
</html>
